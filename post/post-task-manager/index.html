<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Tasks app and microservices architecture | danielfbm</title><meta name=keywords content="architecture,microservices,tasks app,thrift,docker,tutorial,python"><meta name=description content="Task example app architecture"><meta name=author content="map[description:danielfbm email:danielfbm@gmail.com github:https://github.com/danielfbm image:/images/avatar-64x64.png name:danielfbm twitter:https://twitter.com/danielfbm website:http://danielfbm.github.io/]"><link rel=canonical href=https://danielfbm.github.io/post/post-task-manager/><link crossorigin=anonymous href=/assets/css/stylesheet.min.ec8da366ca2fb647537ccb7a8f6fa5b4e9cd3c7a0d3171dd2d3baad1e49c8bfc.css integrity="sha256-7I2jZsovtkdTfMt6j2+ltOnNPHoNMXHdLTuq0eSci/w=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.min.2840b7fccd34145847db71a290569594bdbdb00047097f75d6495d162f5d7dff.js integrity="sha256-KEC3/M00FFhH23GikFaVlL29sABHCX911kldFi9dff8=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://danielfbm.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://danielfbm.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://danielfbm.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://danielfbm.github.io/apple-icon.png><link rel=mask-icon href=https://danielfbm.github.io/apple-icon-precomposed.png><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,o,i,a,t,n,s){e.GoogleAnalyticsObject=t,e[t]=e[t]||function(){(e[t].q=e[t].q||[]).push(arguments)},e[t].l=1*new Date,n=o.createElement(i),s=o.getElementsByTagName(i)[0],n.async=1,n.src=a,s.parentNode.insertBefore(n,s)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-123-45","auto"),ga("send","pageview"))</script><meta property="og:title" content="Tasks app and microservices architecture"><meta property="og:description" content="Task example app architecture"><meta property="og:type" content="article"><meta property="og:url" content="https://danielfbm.github.io/post/post-task-manager/"><meta property="article:section" content="post"><meta property="article:published_time" content="2016-08-21T20:51:42+08:00"><meta property="article:modified_time" content="2016-08-21T20:51:42+08:00"><meta property="og:site_name" content="danielfbm"><meta name=twitter:card content="summary"><meta name=twitter:title content="Tasks app and microservices architecture"><meta name=twitter:description content="Task example app architecture"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://danielfbm.github.io/post/"},{"@type":"ListItem","position":3,"name":"Tasks app and microservices architecture","item":"https://danielfbm.github.io/post/post-task-manager/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Tasks app and microservices architecture","name":"Tasks app and microservices architecture","description":"Task example app architecture","keywords":["architecture","microservices","tasks app","thrift","docker","tutorial","python"],"articleBody":"In this post we will explore some basic concepts while working with a microservices architecture in a distributed application. If you are not very familiar with microservices and the motivation behind it, you should take a look at this series of posts from NGINX that gives a great introduction on the subject.\nAll the concepts are quite simple and although the autor had sugested a few things to get started I will take you through the construction of a simple microservices app that you could deploy anywhere.\nWarning This is a simple introduction and will help you get started with the microservices architecture, and hopefully , with Docker. This series of posts are focused towards beginners and enthusiasts\nArchitecture In this simple app we will split it in three simple parts:\n Client - WebUI that will be responsible to create an interface for the final user WebServer - API Gateway - Will be responsible for authentication and authorisation, simple data validation and forwarding the requests to other services, if necessery. Tasks - A service responsible only to store and manage tasks  In this series we will start from the Tasks service. After we have it ready we will work on our API Gateway and later on we will build an interface for the user.\nTasks service This is a service that will not be reachable from the outside of our network. It is only responsible to store and manage Task related data. One of the biggest advantages of the microservices architecture is that each service can be implemented with different programming languages. Although, in your team, you will want to keep it to the languages that everybody knows, you could still take advantage of using different languages to solve different things.\nFor this service I picked Python and Thrift as the RPC. I will not explain the details of Thrift and why I picked it, and focus more in the implementation, so I suggest you take your time to check some articles about it, or other related RPC technologies, like gRPC.\nIf you prefer to use other language to develop this service, feel free to convert the python syntax to you language of choice. As long as Thrift supports it, everything should work almost exactly the same. If you find some trouble because of the difference, I suggest that you hit the Thrift tutorial for more examples in your language. Keep in mind that the thrift examples are not very updated and you may need to explore a try slight differences in the code to get it working.\nIf you are on a Mac, you can use brew install thrift to download and install the thrift code generator.\nThrift defines its service-client contract API through a thrift file. For our service we will start from there:\n// Basic struct that we will use struct Task { 1: optional string id, 2: string userId, 3: optional string name = \"\", 4: optional string createdOn, 5: optional bool done } // An base exception class exception BaseException { 1: i32 code, 2: string message } // Here is our Tasks service definition. Just like an interface definition // it will give us the signature of the service. With Thrift you, after processing // the file service Tasks { //List Tasks list all(1:string userId), //Add Task Task add(1:string userId, 2:string name), //Update Task update(1:string taskId, 2:string name, 3:bool done, 4:string userId) throws (1:BaseException ouch) //Upsert Task upsert(1:Task task) throws (1:BaseException ouch) } Save this content to a tasks.thrift fileo on the root of your repo and use the thrift cli to generate your server stub\nthrift --gen py tasks.thrift This command will generate a gen-py folder with many files in it\n. ├── __init__.py └── tasks ├── Tasks-remote ├── Tasks.py ├── __init__.py ├── constants.py └── ttypes.py 1 directory, 6 files When I was developing this service I faced many issues while figuring out how to work with Thrift and use it for real. Here I will make it all simple for you.\nI suggest that you start by creating an virtualenv and install the dependencies there. This way you will not polute your computer’s global scope with unecessary dependencies. Here is the requirements.txt\nthriftpy pymongo In order to have a flexible configuration parameter, we will use a configuration file called config.py\nimport os  MONGO_HOST = os.environ.get('MONGO_HOST',  os.environ.get('MONGO_PORT_27017_TCP_ADDR',  os.environ.get('MONGODB_PORT_27017_TCP_ADDR', 'localhost')  )  ) MONGO_PORT = os.environ.get('MONGO_PORT',  os.environ.get('MONGO_PORT_27017_TCP_PORT',  os.environ.get('MONGODB_PORT_27017_TCP_PORT', '27017')  )  ) MONGO_DB = os.environ.get('MONGODB_DATABASE', 'tasks-db')  print(MONGO_HOST) print(MONGO_PORT) class Config:  @staticmethod  def getTaskDBConfig():  return {  'host': MONGO_HOST,  'port': MONGO_PORT,  'db': MONGO_DB  }   @staticmethod  def getTaskServiceConfig():  return {  'host': '0.0.0.0',  'port': 6001  } If you took time to read the code you probably noticed the following:\nMONGO_HOST = os.environ.get('MONGO_HOST',  os.environ.get('MONGO_PORT_27017_TCP_ADDR',  os.environ.get('MONGODB_PORT_27017_TCP_ADDR', 'localhost')  )  ) MONGO_PORT = os.environ.get('MONGO_PORT',  os.environ.get('MONGO_PORT_27017_TCP_PORT',  os.environ.get('MONGODB_PORT_27017_TCP_PORT', '27017')  )  ) This will be used to setup our connection with the database. If you are familiar with python you will probably noticed that there are a few defaults to this file, and also a few options available for each variable. Once we get to the Docker part this will be much easier to understand.\nWe will use Pymongo as our Database interface. Here is the code to implement the basics for the database. Save it as db.py:\nfrom pymongo import MongoClient from bson.objectid import ObjectId  import pymongo import datetime from config import Config import logging  logger = logging.getLogger(__name__) mongoConfig = Config.getTaskDBConfig() baseUrl = 'mongodb://{}:{}'.format(mongoConfig['host'], mongoConfig['port'])  logger.debug('--- MONGO URL: {}'.format(baseUrl)) database = mongoConfig['db']  db = MongoClient(baseUrl) client = db[database]  class TaskDB:  @staticmethod  def all(userId):  return client.tasks.find({\"userId\": userId}).sort(\"createdOn\", pymongo.DESCENDING)   @staticmethod  def addOne(userId, name):  instance = {\"userId\": userId, \"name\": name, \"createdOn\": datetime.datetime.utcnow(), \"done\": False}  instance_id = client.tasks.insert_one(instance).inserted_id  instance[\"_id\"] = instance_id  return instance   @staticmethod  def updateOne(id, userId, name=None, done=None):  print('updateOne(%s,%s,%s,%s)' % (id, name, done, userId))  criteria = {\"userId\": userId, \"_id\": ObjectId(id)}   update = {}  if (name is not None):  print('setting name as %s' % name)  update['name'] = name  if (done is not None):  print('setting done as %s' % done)  update['done'] = done   result = client.tasks.update_one(criteria, {'$set': update})  instance = None  if (result.matched_count  0):  instance = client.tasks.find_one(criteria)   return instance The both files described above will create a simple database manager and a configuration file that you could customize according to your idea. Take note that the DB manager is only connecting at startup and is not managing any connection exceptions or connection failures. This is not good for a production environment, and you should strive to handle failure and reconnect whenever your database connection fails, but this is not the scope of this post so I will leave this for you to change.\nWith this two classes already implemented, what is missing is just a Thrift interface to start our server and connect with the database. save this as server.py\nimport thriftpy tasks = thriftpy.load(\"./tasks.thrift\", module_name=\"tasks_thrift\")  from thriftpy.rpc import make_server from thriftpy.protocol import TJSONProtocolFactory import logging logging.basicConfig()  from db import TaskDB  from config import Config   class TaskHandler(object):   def check(self):  hc = tasks.Healthcheck()  hc.ok = True  hc.message = \"OK\"  return hc   def all(self, userId):  print('getting all tasks for user: %s' % userId)  cursor = TaskDB.all(userId)  result = []  task = None  for t in cursor:  task = tasks.Task()  task.id = str(t['_id'])  task.name = t['name']  task.createdOn = t['createdOn'].isoformat()  task.userId = t['userId']  task.done = t['done']  result.append(task)   return result   def add(self, userId, name):  print('add(%s,%s)' % (userId, name))  instance = TaskDB.addOne(userId, name)   task = TaskHandler.convertInstance(instance)  return task   def update(self, id, name, done, userId):  print('update(%s, %s, %b, %s)' % (id, name, done, userId))   instance = TaskDB.updateOne(id, name, done, userId)   if (instance == None):  exception = tasks.BaseException()  exception.code = 404  exception.mesage = 'Task not found'  raise exception   task = TaskHandler.convertInstance(instance)  return task   def upsert(self, task):  print('upsert(%s)' % (task))  if (task is None):  exception = tasks.BaseException()  exception.code = 400  exception.message = 'Task data is invalid'   try:  if (task.id is not None):  instance = TaskDB.updateOne(task.id, task.userId, task.name, task.done)  else:  instance = TaskDB.addOne(task.userId, task.name)  except (Exception):  exception = tasks.BaseException()  exception.code = 400  exception.message = 'Unkown error'  raise exception   print(instance)  if (instance is None):  exception = tasks.BaseException()  exception.code = 404  exception.message = 'Task not found'  raise exception   task = TaskHandler.convertInstance(instance)  return task   @staticmethod  def convertInstance(instance):  task = tasks.Task()  task.id = str(instance['_id'])  task.userId = instance['userId']  task.name = instance['name']  task.createdOn = instance['createdOn'].isoformat()  task.done = instance['done']  return task  host = Config.getTaskServiceConfig()['host'] port = Config.getTaskServiceConfig()['port']  print('Server is running on %sport %d' % (host, port)) server = make_server(tasks.Tasks,  TaskHandler(),  host,  port) server.serve() You will notice that we finally started to use our thrift generated server skeletton in the first few lines. The TaskHandler class will be the one responsible to receive thrift transported data and implement all the methods declared in our service interface inside our thrift file.\nWith these files you have a very simple service that will handle our Task related data. To start your server you will need first to install MongoDB and then type python server.py in your terminal. As this is a Thrift service, you will need to implement your client. This is an example client that you can use for testing.\nimport thriftpy tasks_thrift = thriftpy.load(\"tasks.thrift\", module_name=\"tasks_thrift\")  from thriftpy.rpc import make_client  client = make_client(tasks_thrift.Tasks, '127.0.0.1', 6000) # Add a task client.add('userid','name')  list = client.all('userid') for l in list:  print l  # Add other functions you want to test # client.update() Save as client.py and start it in another terminal session python client.py\nNow, having all this stuff installed in our computers is not really practical. With time you end up with a computer install with many dependencies and you don’t really use most of them after a while. This is one of the many benefits of using Docker. Go ahead an install it in your machine.\nFor the purpose of this tutorial I created a simple Dockerfile that bundles our Task service in a docker container. Here it is:\n# For now, we can use onbuild kind of image, this is not advised for productionFROMpython:2-onbuildCMD [\"python\", \"./server.py\"]EXPOSE6001This is a simple file useful for development. Don’t use this for production. As you learn more and more about Docker, you will understand that each Docker container should be treated as a remote server, and all the production requirements that comes with it like:\n Handling failure Logging Monitoring Handling database connections  If you are familiar with Linux servers and deploying applications in production, you already know how to do all this. Explaining these are out of the context of this post and we might explore in a later post.\nSave the Dockerfile as Dockerfile in the root of your repo and type docker build -t tasks . to build your docker image.\nNow, you will also want to run your database as a docker container as well, and we will run both of them using docker compose\nversion: '2'  services:  tasks:  image: tasks  ports:  - 6001  environment:  MONGO_HOST: 'mongo'  depends_on:  - mongo  links:  - mongo  mongo:  image: mongo   Save this file as docker-compose.yml in the root of the repo and now you can launch your service, together with a mongo database, from the root of your repo, using the following command:\ndocker-compose up It should be running now in the foreground. If you want it running in the background:\ndocker-compose up -d Now, you might notice that your docker container has its own IP address and ports, so you client file will not work if not changed. To easily test your file you can enter your docker container using the following commands\n# you will need to list your containers first docker ps # grab the name of your tasks container, should be something like tasks_tasks_1 docker exec -it tasks_tasks_1 bash You will notice that you now are currently inside the container but still you can run your client file from within using\npython client.py This project’s code is available in this github repo\nhttps://github.com/danielfbm/tasks-py\nSummary Altough we didn’t explore much in details, In this post we talked about a few topics:\n Microservices architecture Thrift Tasks service using MongoDB Docker basics  In the next post we will explore:\n API gateway REST API User authentication User signup and login Connecting to our Tasks service  Stay tunned.\n","wordCount":"2002","inLanguage":"en","datePublished":"2016-08-21T20:51:42+08:00","dateModified":"2016-08-21T20:51:42+08:00","author":{"@type":"Person","name":{"description":"danielfbm","email":"danielfbm@gmail.com","github":"https://github.com/danielfbm","image":"/images/avatar-64x64.png","name":"danielfbm","twitter":"https://twitter.com/danielfbm","website":"http://danielfbm.github.io/"}},"mainEntityOfPage":{"@type":"WebPage","@id":"https://danielfbm.github.io/post/post-task-manager/"},"publisher":{"@type":"Organization","name":"danielfbm","logo":{"@type":"ImageObject","url":"https://danielfbm.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://danielfbm.github.io accesskey=h title="blog (Alt + H)"><img src=https://danielfbm.github.io/apple-icon.png alt=logo aria-label=logo height=35>blog</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://danielfbm.github.io/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=https://danielfbm.github.io/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://danielfbm.github.io/archives title=Archive><span>Archive</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>Tasks app and microservices architecture</h1><div class=post-description>Task example app architecture</div><div class=post-meta><span title="2016-08-21 20:51:42 +0800 +0800">August 21, 2016</span>&nbsp;·&nbsp;10 min&nbsp;·&nbsp;map[description:danielfbm email:danielfbm@gmail.com github:https://github.com/danielfbm image:/images/avatar-64x64.png name:danielfbm twitter:https://twitter.com/danielfbm website:http://danielfbm.github.io/]</div></header><div class=post-content><p>In this post we will explore some basic concepts while working with a microservices architecture in a distributed application. If you are not very familiar with microservices and the motivation behind it, you should take a look at <a href=https://www.nginx.com/blog/introduction-to-microservices/>this series of posts</a> from NGINX that gives a great introduction on the subject.</p><p>All the concepts are quite simple and although the autor had sugested a few things to get started I will take you through the construction of a simple microservices app that you could deploy anywhere.</p><h4 id=warning>Warning<a hidden class=anchor aria-hidden=true href=#warning>#</a></h4><p>This is a simple introduction and will help you get started with the microservices architecture, and hopefully , with Docker. This series of posts are focused towards beginners and enthusiasts</p><h3 id=architecture>Architecture<a hidden class=anchor aria-hidden=true href=#architecture>#</a></h3><p><img loading=lazy src=/images/Architecture.png alt="Simple architecture"></p><p>In this simple app we will split it in three simple parts:</p><ul><li>Client - WebUI that will be responsible to create an interface for the final user</li><li>WebServer - API Gateway - Will be responsible for authentication and authorisation, simple data validation and forwarding the requests to other services, if necessery.</li><li>Tasks - A service responsible only to store and manage tasks</li></ul><p>In this series we will start from the Tasks service. After we have it ready we will work on our <strong>API Gateway</strong> and later on we will build an interface for the user.</p><h3 id=tasks-service>Tasks service<a hidden class=anchor aria-hidden=true href=#tasks-service>#</a></h3><p>This is a service that will not be reachable from the outside of our network. It is only responsible to store and manage Task related data. One of the biggest advantages of the microservices architecture is that each service can be implemented with different programming languages. Although, in your team, you will want to keep it to the languages that everybody knows, you could still take advantage of using different languages to solve different things.</p><p>For this service I picked Python and Thrift as the RPC. I will not explain the details of <a href=thrift.apache.org>Thrift</a> and why I picked it, and focus more in the implementation, so I suggest you take your time to check some articles about it, or other related RPC technologies, like <a href=grpc.io>gRPC</a>.</p><p>If you prefer to use other language to develop this service, feel free to convert the python syntax to you language of choice. As long as Thrift supports it, everything should work almost exactly the same. If you find some trouble because of the difference, I suggest that you hit the <a href=https://thrift.apache.org/tutorial/>Thrift tutorial</a> for more examples in your language. Keep in mind that the thrift examples are not very updated and you may need to explore a try slight differences in the code to get it working.</p><p>If you are on a Mac, you can use <code>brew install thrift</code> to download and install the thrift code generator.</p><p>Thrift defines its service-client contract API through a <code>thrift</code> file. For our service we will start from there:</p><pre tabindex=0><code>// Basic struct that we will use
struct Task {
  1: optional string id,
  2: string userId,
  3: optional string name = &#34;&#34;,
  4: optional string createdOn,
  5: optional bool done
}

// An base exception class
exception BaseException {
  1: i32 code,
  2: string message
}

// Here is our Tasks service definition. Just like an interface definition
// it will give us the signature of the service. With Thrift you, after processing
// the file 
service Tasks {

  //List Tasks
  list&lt;Task&gt; all(1:string userId),

  //Add Task
  Task add(1:string userId, 2:string name),

  //Update
  Task update(1:string taskId, 2:string name, 3:bool done, 4:string userId) throws (1:BaseException ouch)

  //Upsert
  Task upsert(1:Task task) throws (1:BaseException ouch)

}
</code></pre><p>Save this content to a <code>tasks.thrift</code> fileo on the root of your repo and use the thrift cli to generate your server stub</p><pre tabindex=0><code>thrift --gen py tasks.thrift
</code></pre><p>This command will generate a <code>gen-py</code> folder with many files in it</p><pre tabindex=0><code>.
├── __init__.py
└── tasks
    ├── Tasks-remote
    ├── Tasks.py
    ├── __init__.py
    ├── constants.py
    └── ttypes.py

1 directory, 6 files
</code></pre><p>When I was developing this service I faced many issues while figuring out how to work with Thrift and use it for real. Here I will make it all simple for you.</p><p>I suggest that you start by creating an <code>virtualenv</code> and install the dependencies there. This way you will not polute your computer&rsquo;s global scope with unecessary dependencies. Here is the <code>requirements.txt</code></p><pre tabindex=0><code>thriftpy
pymongo
</code></pre><p>In order to have a flexible configuration parameter, we will use a configuration file called <code>config.py</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> os
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>MONGO_HOST <span style=color:#f92672>=</span> os<span style=color:#f92672>.</span>environ<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#39;MONGO_HOST&#39;</span>, 
</span></span><span style=display:flex><span>                os<span style=color:#f92672>.</span>environ<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#39;MONGO_PORT_27017_TCP_ADDR&#39;</span>, 
</span></span><span style=display:flex><span>                    os<span style=color:#f92672>.</span>environ<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#39;MONGODB_PORT_27017_TCP_ADDR&#39;</span>, <span style=color:#e6db74>&#39;localhost&#39;</span>)
</span></span><span style=display:flex><span>                )
</span></span><span style=display:flex><span>            )
</span></span><span style=display:flex><span>MONGO_PORT <span style=color:#f92672>=</span> os<span style=color:#f92672>.</span>environ<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#39;MONGO_PORT&#39;</span>,
</span></span><span style=display:flex><span>                os<span style=color:#f92672>.</span>environ<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#39;MONGO_PORT_27017_TCP_PORT&#39;</span>, 
</span></span><span style=display:flex><span>                    os<span style=color:#f92672>.</span>environ<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#39;MONGODB_PORT_27017_TCP_PORT&#39;</span>, <span style=color:#e6db74>&#39;27017&#39;</span>)
</span></span><span style=display:flex><span>                )
</span></span><span style=display:flex><span>            )   
</span></span><span style=display:flex><span>MONGO_DB   <span style=color:#f92672>=</span> os<span style=color:#f92672>.</span>environ<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#39;MONGODB_DATABASE&#39;</span>, <span style=color:#e6db74>&#39;tasks-db&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>print(MONGO_HOST)
</span></span><span style=display:flex><span>print(MONGO_PORT)
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Config</span>:
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@staticmethod</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>getTaskDBConfig</span>():
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#39;host&#39;</span>: MONGO_HOST,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#39;port&#39;</span>: MONGO_PORT,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#39;db&#39;</span>: MONGO_DB 
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@staticmethod</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>getTaskServiceConfig</span>():
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#39;host&#39;</span>: <span style=color:#e6db74>&#39;0.0.0.0&#39;</span>,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#39;port&#39;</span>: <span style=color:#ae81ff>6001</span>
</span></span><span style=display:flex><span>        }
</span></span></code></pre></div><p>If you took time to read the code you probably noticed the following:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>MONGO_HOST <span style=color:#f92672>=</span> os<span style=color:#f92672>.</span>environ<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#39;MONGO_HOST&#39;</span>, 
</span></span><span style=display:flex><span>                os<span style=color:#f92672>.</span>environ<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#39;MONGO_PORT_27017_TCP_ADDR&#39;</span>, 
</span></span><span style=display:flex><span>                    os<span style=color:#f92672>.</span>environ<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#39;MONGODB_PORT_27017_TCP_ADDR&#39;</span>, <span style=color:#e6db74>&#39;localhost&#39;</span>)
</span></span><span style=display:flex><span>                )
</span></span><span style=display:flex><span>            )
</span></span><span style=display:flex><span>MONGO_PORT <span style=color:#f92672>=</span> os<span style=color:#f92672>.</span>environ<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#39;MONGO_PORT&#39;</span>,
</span></span><span style=display:flex><span>                os<span style=color:#f92672>.</span>environ<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#39;MONGO_PORT_27017_TCP_PORT&#39;</span>, 
</span></span><span style=display:flex><span>                    os<span style=color:#f92672>.</span>environ<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#39;MONGODB_PORT_27017_TCP_PORT&#39;</span>, <span style=color:#e6db74>&#39;27017&#39;</span>)
</span></span><span style=display:flex><span>                )
</span></span><span style=display:flex><span>            )   
</span></span></code></pre></div><p>This will be used to setup our connection with the database. If you are familiar with python you will probably noticed that there are a few defaults to this file, and also a few options available for each variable. Once we get to the Docker part this will be much easier to understand.</p><p>We will use <code>Pymongo</code> as our Database interface. Here is the code to implement the basics for the database. Save it as <code>db.py</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> pymongo <span style=color:#f92672>import</span> MongoClient
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> bson.objectid <span style=color:#f92672>import</span> ObjectId
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> pymongo
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> datetime
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> config <span style=color:#f92672>import</span> Config
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> logging
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>logger <span style=color:#f92672>=</span> logging<span style=color:#f92672>.</span>getLogger(__name__)
</span></span><span style=display:flex><span>mongoConfig <span style=color:#f92672>=</span> Config<span style=color:#f92672>.</span>getTaskDBConfig()
</span></span><span style=display:flex><span>baseUrl <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;mongodb://</span><span style=color:#e6db74>{}</span><span style=color:#e6db74>:</span><span style=color:#e6db74>{}</span><span style=color:#e6db74>&#39;</span><span style=color:#f92672>.</span>format(mongoConfig[<span style=color:#e6db74>&#39;host&#39;</span>], mongoConfig[<span style=color:#e6db74>&#39;port&#39;</span>])
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>logger<span style=color:#f92672>.</span>debug(<span style=color:#e6db74>&#39;--- MONGO URL: </span><span style=color:#e6db74>{}</span><span style=color:#e6db74>&#39;</span><span style=color:#f92672>.</span>format(baseUrl))
</span></span><span style=display:flex><span>database <span style=color:#f92672>=</span> mongoConfig[<span style=color:#e6db74>&#39;db&#39;</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>db <span style=color:#f92672>=</span> MongoClient(baseUrl)
</span></span><span style=display:flex><span>client <span style=color:#f92672>=</span> db[database]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>TaskDB</span>:
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@staticmethod</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>all</span>(userId):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> client<span style=color:#f92672>.</span>tasks<span style=color:#f92672>.</span>find({<span style=color:#e6db74>&#34;userId&#34;</span>: userId})<span style=color:#f92672>.</span>sort(<span style=color:#e6db74>&#34;createdOn&#34;</span>, pymongo<span style=color:#f92672>.</span>DESCENDING)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@staticmethod</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>addOne</span>(userId, name):
</span></span><span style=display:flex><span>        instance <span style=color:#f92672>=</span> {<span style=color:#e6db74>&#34;userId&#34;</span>: userId, <span style=color:#e6db74>&#34;name&#34;</span>: name, <span style=color:#e6db74>&#34;createdOn&#34;</span>: datetime<span style=color:#f92672>.</span>datetime<span style=color:#f92672>.</span>utcnow(), <span style=color:#e6db74>&#34;done&#34;</span>: <span style=color:#66d9ef>False</span>}
</span></span><span style=display:flex><span>        instance_id <span style=color:#f92672>=</span> client<span style=color:#f92672>.</span>tasks<span style=color:#f92672>.</span>insert_one(instance)<span style=color:#f92672>.</span>inserted_id
</span></span><span style=display:flex><span>        instance[<span style=color:#e6db74>&#34;_id&#34;</span>] <span style=color:#f92672>=</span> instance_id
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> instance
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@staticmethod</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>updateOne</span>(id, userId, name<span style=color:#f92672>=</span><span style=color:#66d9ef>None</span>, done<span style=color:#f92672>=</span><span style=color:#66d9ef>None</span>):
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>&#39;updateOne(</span><span style=color:#e6db74>%s</span><span style=color:#e6db74>,</span><span style=color:#e6db74>%s</span><span style=color:#e6db74>,</span><span style=color:#e6db74>%s</span><span style=color:#e6db74>,</span><span style=color:#e6db74>%s</span><span style=color:#e6db74>)&#39;</span> <span style=color:#f92672>%</span> (id, name, done, userId))
</span></span><span style=display:flex><span>        criteria <span style=color:#f92672>=</span> {<span style=color:#e6db74>&#34;userId&#34;</span>: userId, <span style=color:#e6db74>&#34;_id&#34;</span>: ObjectId(id)}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        update <span style=color:#f92672>=</span> {}
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (name <span style=color:#f92672>is</span> <span style=color:#f92672>not</span> <span style=color:#66d9ef>None</span>):
</span></span><span style=display:flex><span>            print(<span style=color:#e6db74>&#39;setting name as </span><span style=color:#e6db74>%s</span><span style=color:#e6db74>&#39;</span> <span style=color:#f92672>%</span> name)
</span></span><span style=display:flex><span>            update[<span style=color:#e6db74>&#39;name&#39;</span>] <span style=color:#f92672>=</span> name
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (done <span style=color:#f92672>is</span> <span style=color:#f92672>not</span> <span style=color:#66d9ef>None</span>):
</span></span><span style=display:flex><span>            print(<span style=color:#e6db74>&#39;setting done as </span><span style=color:#e6db74>%s</span><span style=color:#e6db74>&#39;</span> <span style=color:#f92672>%</span> done)
</span></span><span style=display:flex><span>            update[<span style=color:#e6db74>&#39;done&#39;</span>] <span style=color:#f92672>=</span> done
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        result <span style=color:#f92672>=</span> client<span style=color:#f92672>.</span>tasks<span style=color:#f92672>.</span>update_one(criteria, {<span style=color:#e6db74>&#39;$set&#39;</span>: update})
</span></span><span style=display:flex><span>        instance <span style=color:#f92672>=</span> <span style=color:#66d9ef>None</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (result<span style=color:#f92672>.</span>matched_count <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>):
</span></span><span style=display:flex><span>            instance <span style=color:#f92672>=</span> client<span style=color:#f92672>.</span>tasks<span style=color:#f92672>.</span>find_one(criteria)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> instance
</span></span></code></pre></div><p>The both files described above will create a simple database manager and a configuration file that you could customize according to your idea. <strong>Take note</strong> that the DB manager is only connecting at startup and is not managing any connection exceptions or connection failures. This is not good for a production environment, and you should strive to handle failure and reconnect whenever your database connection fails, but this is not the scope of this post so I will leave this for you to change.</p><p>With this two classes already implemented, what is missing is just a Thrift interface to start our server and connect with the database. save this as <code>server.py</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> thriftpy
</span></span><span style=display:flex><span>tasks <span style=color:#f92672>=</span> thriftpy<span style=color:#f92672>.</span>load(<span style=color:#e6db74>&#34;./tasks.thrift&#34;</span>, module_name<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;tasks_thrift&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> thriftpy.rpc <span style=color:#f92672>import</span> make_server
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> thriftpy.protocol <span style=color:#f92672>import</span> TJSONProtocolFactory
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> logging
</span></span><span style=display:flex><span>logging<span style=color:#f92672>.</span>basicConfig()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> db <span style=color:#f92672>import</span> TaskDB
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> config <span style=color:#f92672>import</span> Config
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>TaskHandler</span>(object):
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>check</span>(self):
</span></span><span style=display:flex><span>        hc <span style=color:#f92672>=</span> tasks<span style=color:#f92672>.</span>Healthcheck()
</span></span><span style=display:flex><span>        hc<span style=color:#f92672>.</span>ok <span style=color:#f92672>=</span> <span style=color:#66d9ef>True</span>
</span></span><span style=display:flex><span>        hc<span style=color:#f92672>.</span>message <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;OK&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> hc
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>all</span>(self, userId):
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>&#39;getting all tasks for user: </span><span style=color:#e6db74>%s</span><span style=color:#e6db74>&#39;</span> <span style=color:#f92672>%</span> userId)
</span></span><span style=display:flex><span>        cursor <span style=color:#f92672>=</span> TaskDB<span style=color:#f92672>.</span>all(userId)
</span></span><span style=display:flex><span>        result <span style=color:#f92672>=</span> []
</span></span><span style=display:flex><span>        task <span style=color:#f92672>=</span> <span style=color:#66d9ef>None</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> t <span style=color:#f92672>in</span> cursor:
</span></span><span style=display:flex><span>            task <span style=color:#f92672>=</span> tasks<span style=color:#f92672>.</span>Task()
</span></span><span style=display:flex><span>            task<span style=color:#f92672>.</span>id <span style=color:#f92672>=</span> str(t[<span style=color:#e6db74>&#39;_id&#39;</span>])
</span></span><span style=display:flex><span>            task<span style=color:#f92672>.</span>name <span style=color:#f92672>=</span> t[<span style=color:#e6db74>&#39;name&#39;</span>]
</span></span><span style=display:flex><span>            task<span style=color:#f92672>.</span>createdOn <span style=color:#f92672>=</span> t[<span style=color:#e6db74>&#39;createdOn&#39;</span>]<span style=color:#f92672>.</span>isoformat()
</span></span><span style=display:flex><span>            task<span style=color:#f92672>.</span>userId <span style=color:#f92672>=</span> t[<span style=color:#e6db74>&#39;userId&#39;</span>]
</span></span><span style=display:flex><span>            task<span style=color:#f92672>.</span>done <span style=color:#f92672>=</span> t[<span style=color:#e6db74>&#39;done&#39;</span>]
</span></span><span style=display:flex><span>            result<span style=color:#f92672>.</span>append(task)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> result
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>add</span>(self, userId, name):
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>&#39;add(</span><span style=color:#e6db74>%s</span><span style=color:#e6db74>,</span><span style=color:#e6db74>%s</span><span style=color:#e6db74>)&#39;</span> <span style=color:#f92672>%</span> (userId, name))
</span></span><span style=display:flex><span>        instance <span style=color:#f92672>=</span> TaskDB<span style=color:#f92672>.</span>addOne(userId, name)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        task <span style=color:#f92672>=</span> TaskHandler<span style=color:#f92672>.</span>convertInstance(instance)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> task
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>update</span>(self, id, name, done, userId):
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>&#39;update(</span><span style=color:#e6db74>%s</span><span style=color:#e6db74>, </span><span style=color:#e6db74>%s</span><span style=color:#e6db74>, %b, </span><span style=color:#e6db74>%s</span><span style=color:#e6db74>)&#39;</span> <span style=color:#f92672>%</span> (id, name, done, userId))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        instance <span style=color:#f92672>=</span> TaskDB<span style=color:#f92672>.</span>updateOne(id, name, done, userId)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (instance <span style=color:#f92672>==</span> <span style=color:#66d9ef>None</span>):
</span></span><span style=display:flex><span>            exception <span style=color:#f92672>=</span> tasks<span style=color:#f92672>.</span>BaseException()
</span></span><span style=display:flex><span>            exception<span style=color:#f92672>.</span>code <span style=color:#f92672>=</span> <span style=color:#ae81ff>404</span>
</span></span><span style=display:flex><span>            exception<span style=color:#f92672>.</span>mesage <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;Task not found&#39;</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>raise</span> exception
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        task <span style=color:#f92672>=</span> TaskHandler<span style=color:#f92672>.</span>convertInstance(instance)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> task
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>upsert</span>(self, task):
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>&#39;upsert(</span><span style=color:#e6db74>%s</span><span style=color:#e6db74>)&#39;</span> <span style=color:#f92672>%</span> (task))
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (task <span style=color:#f92672>is</span> <span style=color:#66d9ef>None</span>):
</span></span><span style=display:flex><span>            exception <span style=color:#f92672>=</span> tasks<span style=color:#f92672>.</span>BaseException()
</span></span><span style=display:flex><span>            exception<span style=color:#f92672>.</span>code <span style=color:#f92672>=</span> <span style=color:#ae81ff>400</span>
</span></span><span style=display:flex><span>            exception<span style=color:#f92672>.</span>message <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;Task data is invalid&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (task<span style=color:#f92672>.</span>id <span style=color:#f92672>is</span> <span style=color:#f92672>not</span> <span style=color:#66d9ef>None</span>):
</span></span><span style=display:flex><span>                instance <span style=color:#f92672>=</span> TaskDB<span style=color:#f92672>.</span>updateOne(task<span style=color:#f92672>.</span>id, task<span style=color:#f92672>.</span>userId, task<span style=color:#f92672>.</span>name, task<span style=color:#f92672>.</span>done)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>                instance <span style=color:#f92672>=</span> TaskDB<span style=color:#f92672>.</span>addOne(task<span style=color:#f92672>.</span>userId, task<span style=color:#f92672>.</span>name)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>except</span> (<span style=color:#a6e22e>Exception</span>):
</span></span><span style=display:flex><span>            exception <span style=color:#f92672>=</span> tasks<span style=color:#f92672>.</span>BaseException()
</span></span><span style=display:flex><span>            exception<span style=color:#f92672>.</span>code <span style=color:#f92672>=</span> <span style=color:#ae81ff>400</span>
</span></span><span style=display:flex><span>            exception<span style=color:#f92672>.</span>message <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;Unkown error&#39;</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>raise</span> exception
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        print(instance)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (instance <span style=color:#f92672>is</span> <span style=color:#66d9ef>None</span>):
</span></span><span style=display:flex><span>            exception <span style=color:#f92672>=</span> tasks<span style=color:#f92672>.</span>BaseException()
</span></span><span style=display:flex><span>            exception<span style=color:#f92672>.</span>code <span style=color:#f92672>=</span> <span style=color:#ae81ff>404</span>
</span></span><span style=display:flex><span>            exception<span style=color:#f92672>.</span>message <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;Task not found&#39;</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>raise</span> exception
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        task <span style=color:#f92672>=</span> TaskHandler<span style=color:#f92672>.</span>convertInstance(instance)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> task
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@staticmethod</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>convertInstance</span>(instance):
</span></span><span style=display:flex><span>        task <span style=color:#f92672>=</span> tasks<span style=color:#f92672>.</span>Task()
</span></span><span style=display:flex><span>        task<span style=color:#f92672>.</span>id <span style=color:#f92672>=</span> str(instance[<span style=color:#e6db74>&#39;_id&#39;</span>])
</span></span><span style=display:flex><span>        task<span style=color:#f92672>.</span>userId <span style=color:#f92672>=</span> instance[<span style=color:#e6db74>&#39;userId&#39;</span>]
</span></span><span style=display:flex><span>        task<span style=color:#f92672>.</span>name <span style=color:#f92672>=</span> instance[<span style=color:#e6db74>&#39;name&#39;</span>]
</span></span><span style=display:flex><span>        task<span style=color:#f92672>.</span>createdOn <span style=color:#f92672>=</span> instance[<span style=color:#e6db74>&#39;createdOn&#39;</span>]<span style=color:#f92672>.</span>isoformat()
</span></span><span style=display:flex><span>        task<span style=color:#f92672>.</span>done <span style=color:#f92672>=</span> instance[<span style=color:#e6db74>&#39;done&#39;</span>]
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> task
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>host <span style=color:#f92672>=</span> Config<span style=color:#f92672>.</span>getTaskServiceConfig()[<span style=color:#e6db74>&#39;host&#39;</span>]
</span></span><span style=display:flex><span>port <span style=color:#f92672>=</span> Config<span style=color:#f92672>.</span>getTaskServiceConfig()[<span style=color:#e6db74>&#39;port&#39;</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>print(<span style=color:#e6db74>&#39;Server is running on </span><span style=color:#e6db74>%s</span><span style=color:#e6db74> port </span><span style=color:#e6db74>%d</span><span style=color:#e6db74>&#39;</span> <span style=color:#f92672>%</span> (host, port))
</span></span><span style=display:flex><span>server <span style=color:#f92672>=</span> make_server(tasks<span style=color:#f92672>.</span>Tasks,
</span></span><span style=display:flex><span>                    TaskHandler(),
</span></span><span style=display:flex><span>                    host,
</span></span><span style=display:flex><span>                    port)
</span></span><span style=display:flex><span>server<span style=color:#f92672>.</span>serve()
</span></span></code></pre></div><p>You will notice that we finally started to use our <code>thrift</code> generated server skeletton in the first few lines. The <code>TaskHandler</code> class will be the one responsible to receive <code>thrift</code> transported data and implement all the methods declared in our <code>service</code> interface inside our <code>thrift</code> file.</p><p>With these files you have a very simple service that will handle our Task related data. To start your server you will need first to install <a href="https://www.mongodb.com/download-center?jmp=nav#community">MongoDB</a> and then type <code>python server.py</code> in your terminal. As this is a Thrift service, you will need to implement your client. This is an example client that you can use for testing.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> thriftpy
</span></span><span style=display:flex><span>tasks_thrift <span style=color:#f92672>=</span> thriftpy<span style=color:#f92672>.</span>load(<span style=color:#e6db74>&#34;tasks.thrift&#34;</span>, module_name<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;tasks_thrift&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> thriftpy.rpc <span style=color:#f92672>import</span> make_client
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>client <span style=color:#f92672>=</span> make_client(tasks_thrift<span style=color:#f92672>.</span>Tasks, <span style=color:#e6db74>&#39;127.0.0.1&#39;</span>, <span style=color:#ae81ff>6000</span>)
</span></span><span style=display:flex><span><span style=color:#75715e># Add a task</span>
</span></span><span style=display:flex><span>client<span style=color:#f92672>.</span>add(<span style=color:#e6db74>&#39;userid&#39;</span>,<span style=color:#e6db74>&#39;name&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>list <span style=color:#f92672>=</span> client<span style=color:#f92672>.</span>all(<span style=color:#e6db74>&#39;userid&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> l <span style=color:#f92672>in</span> list:
</span></span><span style=display:flex><span>    print l
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Add other functions you want to test</span>
</span></span><span style=display:flex><span><span style=color:#75715e># client.update()</span>
</span></span></code></pre></div><p>Save as <code>client.py</code> and start it in another terminal session <code>python client.py</code></p><p>Now, having all this stuff installed in our computers is not really practical. With time you end up with a computer install with many dependencies and you don&rsquo;t really use most of them after a while. This is <strong>one of the many</strong> benefits of using <a href=https://docker.io>Docker</a>. Go ahead an <a href=https://docs.docker.com/engine/installation/>install it in your machine</a>.</p><p>For the purpose of this tutorial I created a simple <a href=https://docs.docker.com/engine/reference/builder/>Dockerfile</a> that bundles our Task service in a docker container. Here it is:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#75715e># For now, we can use onbuild kind of image, this is not advised for production</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> python:2-onbuild</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>CMD</span> [<span style=color:#e6db74>&#34;python&#34;</span>, <span style=color:#e6db74>&#34;./server.py&#34;</span>]<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>EXPOSE</span><span style=color:#e6db74> 6001</span><span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><p>This is a simple file useful for development. <strong>Don&rsquo;t use this for production</strong>. As you learn more and more about Docker, you will understand that each Docker container should be treated as a remote server, and all the production requirements that comes with it like:</p><ul><li>Handling failure</li><li>Logging</li><li>Monitoring</li><li>Handling database connections</li></ul><p>If you are familiar with Linux servers and deploying applications in production, you already know how to do all this. Explaining these are out of the context of this post and we might explore in a later post.</p><p>Save the Dockerfile as <code>Dockerfile</code> in the root of your repo and type <code>docker build -t tasks .</code> to build your docker image.</p><p>Now, you will also want to run your database as a docker container as well, and we will run both of them using <a href=https://docs.docker.com/compose/>docker compose</a></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>version</span>: <span style=color:#e6db74>&#39;2&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>services</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>tasks</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>image</span>: <span style=color:#ae81ff>tasks</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>          - <span style=color:#ae81ff>6001</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>environment</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>MONGO_HOST</span>: <span style=color:#e6db74>&#39;mongo&#39;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>depends_on</span>:
</span></span><span style=display:flex><span>          - <span style=color:#ae81ff>mongo</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>links</span>:
</span></span><span style=display:flex><span>          - <span style=color:#ae81ff>mongo</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>mongo</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>image</span>: <span style=color:#ae81ff>mongo</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    
</span></span></code></pre></div><p>Save this file as <code>docker-compose.yml</code> in the root of the repo and now you can launch your service, together with a mongo database, from the root of your repo, using the following command:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>docker-compose up
</span></span></code></pre></div><p>It should be running now in the foreground. If you want it running in the background:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>docker-compose up -d
</span></span></code></pre></div><p>Now, you might notice that your docker container has its own IP address and ports, so you client file will not work if not changed. To easily test your file you can enter your docker container using the following commands</p><pre tabindex=0><code># you will need to list your containers first
docker ps
# grab the name of your tasks container, should be something like tasks_tasks_1
docker exec -it tasks_tasks_1 bash
</code></pre><p>You will notice that you now are currently inside the container but still you can run your client file from within using</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>python client.py
</span></span></code></pre></div><p>This project&rsquo;s code is available in this github repo</p><p><a href=https://github.com/danielfbm/tasks-py>https://github.com/danielfbm/tasks-py</a></p><h3 id=summary>Summary<a hidden class=anchor aria-hidden=true href=#summary>#</a></h3><p>Altough we didn&rsquo;t explore much in details, In this post we talked about a few topics:</p><ul><li>Microservices architecture</li><li>Thrift</li><li>Tasks service using MongoDB</li><li>Docker basics</li></ul><p>In the next post we will explore:</p><ul><li>API gateway</li><li>REST API</li><li>User authentication</li><li>User signup and login</li><li>Connecting to our Tasks service</li></ul><p>Stay tunned.</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://danielfbm.github.io/tags/architecture/>architecture</a></li><li><a href=https://danielfbm.github.io/tags/microservices/>microservices</a></li><li><a href=https://danielfbm.github.io/tags/tasks-app/>tasks app</a></li><li><a href=https://danielfbm.github.io/tags/docker/>docker</a></li><li><a href=https://danielfbm.github.io/tags/thirft/>thirft</a></li><li><a href=https://danielfbm.github.io/tags/dockerfile/>Dockerfile</a></li><li><a href=https://danielfbm.github.io/tags/example/>example</a></li><li><a href=https://danielfbm.github.io/tags/tutorial/>tutorial</a></li><li><a href=https://danielfbm.github.io/tags/python/>python</a></li></ul><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share Tasks app and microservices architecture on twitter" href="https://twitter.com/intent/tweet/?text=Tasks%20app%20and%20microservices%20architecture&url=https%3a%2f%2fdanielfbm.github.io%2fpost%2fpost-task-manager%2f&hashtags=architecture%2cmicroservices%2ctasksapp%2cdocker%2cthirft%2cDockerfile%2cexample%2ctutorial%2cpython"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Tasks app and microservices architecture on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fdanielfbm.github.io%2fpost%2fpost-task-manager%2f&title=Tasks%20app%20and%20microservices%20architecture&summary=Tasks%20app%20and%20microservices%20architecture&source=https%3a%2f%2fdanielfbm.github.io%2fpost%2fpost-task-manager%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Tasks app and microservices architecture on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fdanielfbm.github.io%2fpost%2fpost-task-manager%2f&title=Tasks%20app%20and%20microservices%20architecture"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Tasks app and microservices architecture on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fdanielfbm.github.io%2fpost%2fpost-task-manager%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Tasks app and microservices architecture on whatsapp" href="https://api.whatsapp.com/send?text=Tasks%20app%20and%20microservices%20architecture%20-%20https%3a%2f%2fdanielfbm.github.io%2fpost%2fpost-task-manager%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Tasks app and microservices architecture on telegram" href="https://telegram.me/share/url?text=Tasks%20app%20and%20microservices%20architecture&url=https%3a%2f%2fdanielfbm.github.io%2fpost%2fpost-task-manager%2f"><svg viewBox="2 2 28 28"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div></footer></article></main><footer class=footer><span>&copy; 2022 <a href=https://danielfbm.github.io>danielfbm</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(t){t.preventDefault();var e=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView({behavior:"smooth"}),e==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${e}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>